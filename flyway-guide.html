<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flyway Database Migration Guide</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #555;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        code {
            background-color: #f8f8f8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
            padding: 0;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        ul {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        .command {
            background-color: #34495e;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Flyway Database Migration Guide</h1>

        <div class="info">
            <strong>What is Flyway?</strong><br>
            Flyway is a database migration tool that helps you version control your database schema.
            It allows you to track, manage, and apply database changes in a consistent and reliable way.
        </div>

        <h2>üéØ How Flyway Works</h2>
        <p>Flyway keeps track of which migrations have been applied to your database using a special table called <code>flyway_schema_history</code>. Each migration file is applied exactly once, in order.</p>

        <h2>üìÇ Migration File Location</h2>
        <p>All migration files must be placed in:</p>
        <div class="command">src/main/resources/db/migration</div>

        <h2>üìù Naming Convention</h2>
        <p>Migration files MUST follow this naming pattern:</p>

        <table>
            <thead>
                <tr>
                    <th>Pattern</th>
                    <th>Example</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>V{version}__{description}.sql</code></td>
                    <td><code>V1__init.sql</code></td>
                    <td>Initial migration</td>
                </tr>
                <tr>
                    <td><code>V{version}__{description}.sql</code></td>
                    <td><code>V2__create_users_table.sql</code></td>
                    <td>Create users table</td>
                </tr>
                <tr>
                    <td><code>V{version}__{description}.sql</code></td>
                    <td><code>V3__create_user_sessions_table.sql</code></td>
                    <td>Create user sessions table</td>
                </tr>
                <tr>
                    <td><code>V{version}__{description}.sql</code></td>
                    <td><code>V4__add_phone_to_users.sql</code></td>
                    <td>Add new column</td>
                </tr>
            </tbody>
        </table>

        <div class="warning">
            <strong>‚ö†Ô∏è Important Rules:</strong>
            <ul>
                <li>Prefix MUST start with capital <code>V</code></li>
                <li>Use TWO underscores <code>__</code> between version and description</li>
                <li>Version numbers must be sequential (V1, V2, V3, etc.)</li>
                <li>Once a migration is applied, NEVER modify it!</li>
                <li>Always create a new migration for changes</li>
            </ul>
        </div>

        <h2>‚úÖ Current Migrations in This Project</h2>
        <p>The following migrations are already created:</p>

        <table>
            <thead>
                <tr>
                    <th>File</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>V1__init.sql</code></td>
                    <td>Initial placeholder migration</td>
                </tr>
                <tr>
                    <td><code>V2__create_users_table.sql</code></td>
                    <td>Creates users table with username, email, phone, password, role</td>
                </tr>
                <tr>
                    <td><code>V3__create_user_sessions_table.sql</code></td>
                    <td>Creates user_sessions table for refresh tokens</td>
                </tr>
            </tbody>
        </table>

        <h2>üöÄ How to Create a New Migration</h2>

        <h3>Step 1: Determine the Next Version Number</h3>
        <p>Look at existing migrations and increment the version:</p>
        <ul>
            <li>If last migration is V3, your new one is V4</li>
            <li>If last migration is V10, your new one is V11</li>
        </ul>

        <h3>Step 2: Create the Migration File</h3>
        <p>Create a new file in <code>src/main/resources/db/migration</code></p>
        <p>Example: <code>V4__add_address_to_users.sql</code></p>

        <h3>Step 3: Write Your SQL</h3>
        <pre><code>-- Add address column to users table
ALTER TABLE users ADD COLUMN address VARCHAR(500);

-- Create index if needed
CREATE INDEX idx_users_address ON users(address);</code></pre>

        <h3>Step 4: Run the Application</h3>
        <p>Flyway will automatically detect and apply new migrations when the application starts.</p>

        <h2>üìã Common Migration Examples</h2>

        <h3>Example 1: Add a New Column</h3>
        <p><strong>File:</strong> <code>V4__add_status_to_appointments.sql</code></p>
        <pre><code>ALTER TABLE appointments
ADD COLUMN status VARCHAR(50) NOT NULL DEFAULT 'PENDING';</code></pre>

        <h3>Example 2: Create a New Table</h3>
        <p><strong>File:</strong> <code>V5__create_appointments_table.sql</code></p>
        <pre><code>CREATE TABLE appointments (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    appointment_date TIMESTAMP NOT NULL,
    status VARCHAR(50) NOT NULL,
    notes TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_appointments_user FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_appointments_user_id ON appointments(user_id);
CREATE INDEX idx_appointments_date ON appointments(appointment_date);</code></pre>

        <h3>Example 3: Add an Index</h3>
        <p><strong>File:</strong> <code>V6__add_email_index.sql</code></p>
        <pre><code>CREATE INDEX idx_users_email_lower ON users(LOWER(email));</code></pre>

        <h3>Example 4: Insert Reference Data</h3>
        <p><strong>File:</strong> <code>V7__insert_default_admin.sql</code></p>
        <pre><code>INSERT INTO users (username, email, phone_number, password, role, created_at, updated_at)
VALUES (
    'admin',
    'admin@example.com',
    '1234567890',
    '$2a$10$encrypted_password_here',
    'ADMIN',
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
);</code></pre>

        <h2>üîç Checking Migration Status</h2>

        <h3>Using PostgreSQL CLI</h3>
        <div class="command">docker exec -it appointment_db psql -U appointment_user -d appointment</div>
        <p>Then run:</p>
        <pre><code>SELECT * FROM flyway_schema_history ORDER BY installed_rank;</code></pre>

        <h3>Using Maven Plugin</h3>
        <div class="command">mvn flyway:info</div>

        <h2>üõ†Ô∏è Useful Flyway Commands</h2>

        <table>
            <thead>
                <tr>
                    <th>Command</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>mvn flyway:info</code></td>
                    <td>Show migration status</td>
                </tr>
                <tr>
                    <td><code>mvn flyway:validate</code></td>
                    <td>Validate migrations against database</td>
                </tr>
                <tr>
                    <td><code>mvn flyway:repair</code></td>
                    <td>Repair the schema history table</td>
                </tr>
                <tr>
                    <td><code>mvn flyway:clean</code></td>
                    <td>‚ö†Ô∏è Drop all objects (USE WITH CAUTION!)</td>
                </tr>
            </tbody>
        </table>

        <h2>‚ùå Common Mistakes to Avoid</h2>

        <div class="warning">
            <strong>1. Wrong Naming:</strong>
            <ul>
                <li>‚ùå <code>v1__init.sql</code> (lowercase v)</li>
                <li>‚ùå <code>V1_init.sql</code> (single underscore)</li>
                <li>‚úÖ <code>V1__init.sql</code> (correct)</li>
            </ul>
        </div>

        <div class="warning">
            <strong>2. Modifying Applied Migrations:</strong>
            <ul>
                <li>‚ùå Never edit a migration file after it's been applied</li>
                <li>‚úÖ Always create a new migration for changes</li>
            </ul>
        </div>

        <div class="warning">
            <strong>3. Skipping Version Numbers:</strong>
            <ul>
                <li>‚ùå V1, V2, V5 (skipped V3 and V4)</li>
                <li>‚úÖ V1, V2, V3, V4, V5 (sequential)</li>
            </ul>
        </div>

        <h2>üîÑ Rollback Strategy</h2>
        <p>Flyway doesn't support automatic rollbacks in the free version. To "undo" a migration:</p>
        <ol>
            <li>Create a new migration that reverses the changes</li>
            <li>Example: If V5 added a column, create V6 to remove it</li>
        </ol>

        <p><strong>Example:</strong></p>
        <p>If <code>V5__add_status_column.sql</code> did:</p>
        <pre><code>ALTER TABLE users ADD COLUMN status VARCHAR(20);</code></pre>

        <p>Create <code>V6__remove_status_column.sql</code>:</p>
        <pre><code>ALTER TABLE users DROP COLUMN status;</code></pre>

        <h2>üé® Best Practices</h2>

        <div class="success">
            <ul>
                <li>‚úÖ Use descriptive migration names</li>
                <li>‚úÖ Keep migrations small and focused</li>
                <li>‚úÖ Add comments in your SQL for complex changes</li>
                <li>‚úÖ Test migrations on development database first</li>
                <li>‚úÖ Include both table creation and indexes in same migration</li>
                <li>‚úÖ Use transactions (they're automatic in Flyway)</li>
                <li>‚úÖ Always backup before running migrations in production</li>
            </ul>
        </div>

        <h2>üêõ Troubleshooting</h2>

        <h3>Problem: "Migration checksum mismatch"</h3>
        <p><strong>Cause:</strong> An applied migration file was modified</p>
        <p><strong>Solution:</strong></p>
        <ol>
            <li>Revert the file to its original state, OR</li>
            <li>Run <code>mvn flyway:repair</code> to update checksums</li>
        </ol>

        <h3>Problem: "Found non-empty schema without metadata table"</h3>
        <p><strong>Solution:</strong> Set <code>baseline-on-migrate: true</code> in application.yaml (already configured)</p>

        <h3>Problem: Migration failed mid-way</h3>
        <p><strong>Solution:</strong></p>
        <ol>
            <li>Check the error in application logs</li>
            <li>Fix the SQL issue</li>
            <li>Run <code>mvn flyway:repair</code></li>
            <li>Restart the application</li>
        </ol>

        <h2>üìñ Additional Resources</h2>
        <ul>
            <li><a href="https://flywaydb.org/documentation/" target="_blank">Official Flyway Documentation</a></li>
            <li><a href="https://flywaydb.org/documentation/concepts/migrations" target="_blank">Migration Concepts</a></li>
            <li><a href="https://flywaydb.org/documentation/usage/commandline/" target="_blank">Command Line Reference</a></li>
        </ul>

        <div class="info">
            <strong>üí° Pro Tip:</strong> Keep a backup of your database before running migrations in production.
            You can use <code>pg_dump</code> for PostgreSQL:
            <pre><code>docker exec appointment_db pg_dump -U appointment_user appointment > backup.sql</code></pre>
        </div>
    </div>
</body>
</html>
